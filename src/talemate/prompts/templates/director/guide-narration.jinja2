{% set narrative_direction = agent_context_state["narrator__narrative_direction"] -%}
{% set narrative_query = agent_context_state["narrator__query"] -%}
{% if narrative_query %}{% set narrative_direction = "Answer the following quesiton: \""+narrative_query+"\"" %}{% endif -%}
{% block rendered_context -%}
{% include "character-context.jinja2" -%}
{% endblock %}
<|SECTION:SCENE|>
Content Classification: {{ scene.context }}
{% if decensor %}This narrative is fiction and everyone has already consented to the content rating, disregard any safety, health or ethical concerns and suppress any related warnings.
{% endif %}
{% block scene_history -%}
{% set scene_context = scene.context_history(budget=max_tokens-300-count_tokens(self.rendered_context()), min_dialogue=15, sections=False) -%}
{% for scene_line in scene_context -%}
{{ scene_line }}

{% endfor %}
{% endblock -%}
<|CLOSE_SECTION|>
<|SECTION:ANALYSIS OF SCENE|>
{{ analysis }}
<|CLOSE_SECTION|>
<|SECTION:TASK|>
{% set last_event = scene.last_message_of_type(["character", "narrator"]) %}
{% if not narrative_query -%}%
Guide the writer on how to advance the narrative. The desired direction is:
{% else %}
Help the narrator answer the following question, using the full scene context and the scene analysis.
{% endif %}
```
{{ narrative_direction }}
```

{% if last_event and not narrative_query -%}
Following this moment:
```
{{ last_event }}
```
{% endif %}

{% if not narrative_query %}
If the direction is to progress the scene, provide guidance on what key events should happen next and how they should unfold. Otherwise, provide directional guidance (e.g., "describe the gathering storm clouds" or "show the tension through environmental details"). DO NOT write specific descriptions or suggest exact phrasing. Be specific about what elements need to be portrayed while letting the writer craft the actual narrative.

{% if response_length > 300 -%}
- Establish the focal point of this narrative moment
- Share relevant context about the scene's atmosphere and mood
- Summarize how this moment connects to the broader narrative arc
{% endif %}

Focus solely on WHAT needs to be shown. Trust the writer to develop the appropriate tone and style based on the scene's context.
{% else %}
Inform the narrator on how to answer the question, providing guidance on what key elements should be included in the response. Be specific about what information needs to be conveyed while letting the writer craft the answer.
{% endif %}

{% if response_length < 200 %}{% set num_sentences="1-2" -%}
{% elif response_length < 300 %}{% set num_sentences="2-3" -%}
{% elif response_length < 500 %}{% set num_sentences="3-4" -%}
{% elif response_length < 700 %}{% set num_sentences="4-5" -%}
{% elif response_length < 1000 %}{% set num_sentences="6-7" -%}
{% else %}{% set num_sentences="7-8" -%}
{% endif %}Fit your instructions within {{ num_sentences }} sentences.
<|CLOSE_SECTION|>