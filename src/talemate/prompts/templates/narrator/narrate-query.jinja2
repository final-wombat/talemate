{% block rendered_context %}
<|SECTION:CONTEXT|>
{%- with memory_query=query -%}
    {% include "extra-context.jinja2" %}
{% endwith -%}
<|CLOSE_SECTION|>
{% endblock %}
{% for scene_context in scene.context_history(budget=max_tokens-200-count_tokens(self.rendered_context())) -%}
{{ loop.index }}. {{ scene_context }}
{% endfor %}
<|SECTION:TASK|>
{% if query.endswith("?") -%}
Instruction: Analyze Context, History and Dialogue and then answer the question: "{{ query }}". 

When evaluating both story and context, story is more important. You can fill in gaps using imagination as long as it is based on the existing context. 

Respect the scene progression and answer in the context of line {{ len(scene.context_history(budget=max_tokens-300)) }}.

Use your imagination to fill in gaps in order to answer the question in a confident and decisive manner. Avoid uncertainty and vagueness.
Question: {{ query }}
{% else -%}
Instruction: {{ query }}
Answer based on Context, History and Dialogue. 
When evaluating both story and context, story is more important. You can fill in gaps using imagination as long as it is based on the existing context. 
{% endif -%}
Content Context: This is a specific scene from {{ scene.context }}
Your answer should be in the style of short, concise narration that fits the context of the scene. (1 to 2 sentences)
{{ extra_instructions }}
<|CLOSE_SECTION|>
{% if query.endswith("?") -%}Answer: {% endif %}{% if at_the_end %}{{ bot_token }}At the end of the dialogue, {% endif %}