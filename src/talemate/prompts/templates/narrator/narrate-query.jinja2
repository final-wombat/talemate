{% block rendered_context %}
<|SECTION:CONTEXT|>
{%- with memory_query=query -%}
    {% include "extra-context.jinja2" %}
{% endwith -%}
{% set related_character = scene.parse_character_from_line(query) -%}
{% if related_character -%}
<|SECTION:{{ related_character.name|upper }}|>
{{ related_character.sheet}}
{% endif %}
<|CLOSE_SECTION|>
{% endblock %}
<|SECTION:SCENE|>
{% set scene_history=scene.context_history(budget=max_tokens-200-count_tokens(self.rendered_context()))  %}
{% set final_line_number=len(scene_history) %}
{% for scene_context in scene_history -%}
{{ scene_context }}

{% endfor %}
<|CLOSE_SECTION|>
<|SECTION:TASK|>
{% set last_message = scene.last_message_of_type(["character", "narrator"]) %}
{% if query.endswith("?") -%}
Instruction: Analyze Context, History and Dialogue and then answer the question: "{{ query }}". 
{% else -%}
Instruction: {{ query }}
{% endif %}
Answer queries about the current scene or world without advancing the plot.

Use the established context to inform your responses, anchoring them to final line in the scene.

{% if last_message %}
``` the final line in the scene
{{ last_message }}
```
{% endif -%}

Provide information that maintains continuity with everything up to and including the final line.

Respond as an omniscient, all-seeing narrator with deep knowledge of the story world.
Maintain an informal, conversational tone similar to 90s adventure games.
Respond with 1-2 sentences of concise narration fitting the scene's context.
Avoid direct speech or dialogue. Focus on descriptive prose and implied experiences.
Embody the narrator's role completely, using a unique narrative voice.

Answer questions confidently and decisively through your perspective, without progressing the story.

{{ extra_instructions }}

Context: This scene is set within {{ scene.context }}.
Question(s): {{query}}
{% include "rerun-context.jinja2" -%}
<|CLOSE_SECTION|>
{% if query.endswith("?") -%}Answer: {% endif -%}