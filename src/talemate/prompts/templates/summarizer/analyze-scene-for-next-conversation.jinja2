{% block rendered_context -%}
{% include "character-context.jinja2" -%}
{% endblock %}
<|SECTION:SCENE|>
{% block scene_history -%}

{% set scene_context = scene.context_history(
    budget=max_tokens-300-count_tokens(self.rendered_context()), 
    min_dialogue=15, 
    sections=False, 
    keep_director=False, 
    chapter_labels=True
    ) 
-%}
{% for scene_line in scene_context -%}
{{ scene_line }}

{% endfor %}
<|CLOSE_SECTION|>
{% if context_investigation %}
<|SECTION:HISTORIC CONTEXT|>
{{ context_investigation }}
<|CLOSE_SECTION|>
{% endif %}
{% endblock -%}
<|SECTION:TASK|>
{% set last_message = scene.last_message_of_type(["character", "narrator"]) -%}
{% set character_direction=scene.last_message_of_type("director", source=character.name, max_iterations=15) -%}
{% set bullet_num=0 -%}
Your task is to analyze the scene progression so far and how it informs what {{ character.name }}'s next line or action in the scene will be.

The information you write will be given to the other story editors to write {{ character.name }}'s next action in the scene.

{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) Briefly make statements about context, meaning and facts established relevant to the current moment in the scene. Facts are sourced from the existing story, don't assume, only state things that are explicitly true.

{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) Brielfy list who the characters in the scene are to each other. (Include {{ character.name }})

{% if character_direction %}{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) The story editors were given the following direction: "{{ character_direction }}". Briefly analyse the direction, what does it mean for {{ character.name }}'s next action?
{% endif %}
{% if last_message -%}
{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) Briefly the meaning of the final line in the scene. What was the meaning of their dialogue and actions?

``` final line in the scene
{{ last_message }}
```

{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) Is {{ character.name }} aware of the final line? This is IMPORTANT - It cannot affect their next action if they are not aware. You must be very explicit about this and either say Yes or No.
{% endif %}

{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) What is the cadence and nature of the current dialogue? Is it ongoing or is a new dialogue starting? 

{% if context_investigation -%}
{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) Briefly explain what you understand from the historical context and if you think it's relevant. Note that the 'Historical Context' section has been filled in from a previous prompt and may not be relevant at all.
{% endif %}
{% if deep_analysis -%}
{% set bullet_num = bullet_num+1 %}{{ bullet_num }}) You may tell the story editors to read through any chapter(s) that may provide additional information to help guide them in writing the continuation of the scene for {{ character.name }}. To do this simply state "Read through chapter {number} to find out ..." followed by a specific detail you wish to understand. What question are you looking to answer? Avoid generic and broad queries and explain why the answer will help guide the story editors.

You may instruct them to read {{ max_content_investigations }} chapter(s).

The chapter number is always two digits separated by a period.
{% endif %}

{% if length == "medium" %}Your analysis should be 2 - 3 paragraphs long.{% elif length == "short" %}Your analysis should be 1 - 2 paragraphs long.{% endif %}

Use natural and easy to read language and plain-text formatting in your response. 
<|CLOSE_SECTION|>